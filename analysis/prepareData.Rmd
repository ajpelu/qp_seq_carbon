---
title: "Prepare Data from Forest Inventories"
output: pdf_document
editor_options: 
  chunk_output_type: console
---

```{r, message=FALSE, warning=FALSE}
source("./load_pkgs.R")
```


# MIGRAME 

We downloaded the DarwinCore Archive (`.zip` file) of our dataset from GBIF ([doi: 10.15470/orboj4](https://doi.org/10.15470/orboj4)). Then, we use the `finch` package [@finch] to process the Darwin Core Archive and load the datasets. 

```{r}
# x <- dwca_read("https://ipt.gbif.es/archive.do?r=migrame")
# 
# mig_occ <- read_delim(x$data[1], delim = "\t")
# mig_mof <- read_delim(x$data[2], delim = "\t")

mig_occ <- read_delim(here::here("raw_data/migrame/dwca-migrame-v1.8/occurrence.txt"), delim = "\t")
mig_mof <- read_delim(here::here("raw_data/migrame/dwca-migrame-v1.8/measurementorfact.txt"), delim = "\t")


# Get transect data 
# Transect data comes from Supplementary of https://doi.org/10.3897/phytokeys.56.5482 

# Table S1. Information about transects of the project. Elevation in m a.s.l.. 
# Type: AM = Altitudinal migration; FO = Forest; MH = Marginal Habitat. 
# Subtype: 
#   AC-e = Abandoned Cropland: edge; AC-i = Abandoned Cropland: inside; 
#   Pp-e = Pine plantations: edge; Pp-i: Pine plantations: inside; 
#   TE = Treeline Ecotone. 
# Locality: CA = Robledal de Cáñar; SJ = Robledal de San Juan.

mig_transectos <- read.table(here::here("raw_data/migrame/appendix_transects.csv"))
```


### Selección de datos

- Transectos realizados dentro del robledal

```{r}
fo <- mig_transect %>% 
  filter(type == "FO") %>% as.data.frame()


# Prepare measurements
g <- mig_mof %>% dplyr::select(id, measurementType, measurementValue) %>% 
  spread(measurementType, measurementValue) %>% 
  rename(dbh = `diameter size`, h = `tree height`)

mig <- g %>% inner_join(mig_occ, by = "id") %>% 
  mutate(loc = case_when(
             locality == "Robledal de San Juan. Barranco de San Juan" ~ "SJ",
             locality == "Robledal de Cañar. Loma de Cañar" ~ "CA")) %>% 
  dplyr::select(id, dbh, h, eventDate, catalogNumber, loc, scientificName) %>% 
  separate(catalogNumber, c(NA, "tr", NA), sep ="-") %>% 
  filter(tr %in% unique(fo$id_transect)) %>% 
  mutate(sp = case_when(
    scientificName == "Quercus pyrenaica Willd." ~ "Qpyr",
    scientificName == "Quercus ilex L. subsp. ballota" ~ "Qilex"
  ))

write_csv(mig, here::here("data/df_mig.csv"))


# Read spatial info 

mig_spa <- rgdal::readOGR(dsn = here::here("/raw_data/geoinfo"), 
                   layer = "mig_transectos_polygon", 
                   verbose = TRUE, encoding = "UTF-8")

# Select transects and variables
mig_spaFO <- subset(mig_spa, nombre %in% unique(fo$id_transect))
mig_spaFO <- mig_spaFO[, c("nombre", "fecha")]
names(mig_spaFO) <- c("code", "date")

writeOGR(mig_spaFO, 
         dsn = here::here("/data/geoinfo"), 
         "plotQP_lidar", driver="ESRI Shapefile", overwrite_layer = TRUE)
```


# Dendro SN 

* Data from Pérez-Luque et al. (Submitted to *Ecosystems*).
* 50 target trees were cored for dendrochronological analysis
* Stand competition of target trees was assessed by recording distance, azimuth, DBH, species and total height of all neighboring living trees with DBH > 7.5 cm within a circular plot of 10 m radius.

```{r}
# Read spatial info 
dendrosn_spa <- rgdal::readOGR(dsn = here::here("/raw_data/geoinfo"), 
                   layer = "dendro_sn_polygon", 
                   verbose = TRUE, encoding = "UTF-8")

dendrosn_spa <- dendrosn_spa[, c("name", "cmt")]

dendrosn_spa@data$date <- parse_date(str_sub(dendrosn_spa@data$cmt, end=-10))
dendrosn_spa <- dendrosn_spa[, c("name", "date")]
names(dendrosn_spa)[1] <- "code"

``` 


# Dendro LIFE

* Data from monitoring dendro LIFE-ADAPTAMED
* Several plots in Pyrenean oaks forest with variable size 
* Distance, azimuth, DBH, species and height of all living trees within a circular plot of variable radius were registered. 

```{r}
# Read spatial info 
dendrolife_spa <- rgdal::readOGR(dsn = here::here("/raw_data/geoinfo"), 
                   layer = "dendro_life_polygon", 
                   verbose = TRUE, encoding = "UTF-8")
dendrolife_spa <- dendrolife_spa[, c("code", "date")]
dendrolife_spa@data$date <- parse_date(dendrolife_spa@data$date)
```

# OBSNEV San Jeronimo 

* 9 parcelas en el robledal de San Jerónimo
* 3 réplicas x 3 tratamientos (Control / Moderado / Intenso)
  
  * Control: No actuación. Parcelas de 20 x 20 m. En ellas se toman los datos de 10 individuos (distancia al centro; rumbo; dbh; diametro basal; altura) y también se toman datos del resto de individuos (diámetro basal y dbh)
  
  * Moderada: Eliminación de pies secos/enfermos, y los incluidos en una agrupación (conjunto de robles que distan entre sí menos de 3 m.) y que tengan un diámetro basal < 15 cm. 
  
  * Intenso: idem moderada + incremento de corta hasta 30 % seleccionándose para ello los pies enfermos, dominados y/o excesivamente densos, eliminándose en este último caso alguno de los pies que estén más próximos. 

### Inconvenientes / DUDAS: 
* Solamente las parcelas control no fueron tratadas, por lo que tendríamos solamente 3 parcelas. 
* De las otras, siempre tendríamos en torno al centroide 10 árboles localizados (con todas sus medidas)
* De las parcelas control, solamente tenemos datos completos de 10 árboles. Del resto de los árboles de la parcela tenemos datos de diámetros. Podemos no utilizarlos o realizar una estimación de la altura a partir de ecuaciónes de regresión. 

```{r}
# Read spatial info 
obsnev_sjer <- rgdal::readOGR(dsn = here::here("/raw_data/geoinfo"), 
                   layer = "obsnev_sjeronimo_polygon",
                   verbose = TRUE, encoding = "UTF-8")
obsnev_sjer <- obsnev_sjer[, c("code", "fecha")]
names(obsnev_sjer)[2] <- "date"
obsnev_sjer@data$date <- parse_date(obsnev_sjer@data$date)
```









